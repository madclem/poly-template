import * as POLY from 'poly/Poly';
import frag from './shaders/basic.frag';
import vert from './shaders/basic.vert';
import {mat4} from 'gl-matrix';

let gl, program, cube, rot = 0, angle;

let mvMatrix = mat4.create();
let pMatrix = mat4.create();


function draw() 
{
    rot += .02;

    gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    mat4.perspective(pMatrix, 45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0);
    mat4.identity(mvMatrix);
    mat4.translate(mvMatrix, mvMatrix, [-0, 0.0, -7.0]);
    mat4.rotate(mvMatrix, mvMatrix, rot, [0, 1, 1]);

    program.uniforms.modelViewMatrix = mvMatrix;
    program.uniforms.projectionMatrix = pMatrix;
    
    POLY.GL.draw(cube);
}


let init = ()=>{
    let canvas = document.getElementById("canvas");
    POLY.init(canvas);
    gl = POLY.gl;

    let uniforms = 
    {
        projectionMatrix: pMatrix,
        modelViewMatrix: mvMatrix 
    }

    program = new POLY.Program(vert, frag, uniforms);
    cube = new POLY.Mesh(program);

    const vertices = [
        // Front face
        -1.0, -1.0,  1.0,
         1.0, -1.0,  1.0,
         1.0,  1.0,  1.0,
        -1.0,  1.0,  1.0,

        // Back face
        -1.0, -1.0, -1.0,
        -1.0,  1.0, -1.0,
         1.0,  1.0, -1.0,
         1.0, -1.0, -1.0,

        // Top face
        -1.0,  1.0, -1.0,
        -1.0,  1.0,  1.0,
         1.0,  1.0,  1.0,
         1.0,  1.0, -1.0,

        // Bottom face
        -1.0, -1.0, -1.0,
         1.0, -1.0, -1.0,
         1.0, -1.0,  1.0,
        -1.0, -1.0,  1.0,

        // Right face
         1.0, -1.0, -1.0,
         1.0,  1.0, -1.0,
         1.0,  1.0,  1.0,
         1.0, -1.0,  1.0,

        // Left face
        -1.0, -1.0, -1.0,
        -1.0, -1.0,  1.0,
        -1.0,  1.0,  1.0,
        -1.0,  1.0, -1.0
    ];

    let colors = [
        [1.0, 0.0, 0.0, 1.0], // Front face
        [1.0, 1.0, 0.0, 1.0], // Back face
        [0.0, 1.0, 0.0, 1.0], // Top face
        [1.0, 0.5, 0.5, 1.0], // Bottom face
        [1.0, 0.0, 1.0, 1.0], // Right face
        [0.0, 0.0, 1.0, 1.0]  // Left face
    ];
    let unpackedColors = [];
    for (let i in colors) {
        let color = colors[i];
        for (let j=0; j < 4; j++) {
            unpackedColors = unpackedColors.concat(color);
        }
    }


    var cubeVertexIndices = [
        0, 1, 2,      0, 2, 3,    // Front face
        4, 5, 6,      4, 6, 7,    // Back face
        8, 9, 10,     8, 10, 11,  // Top face
        12, 13, 14,   12, 14, 15, // Bottom face
        16, 17, 18,   16, 18, 19, // Right face
        20, 21, 22,   20, 22, 23  // Left face
    ];


    cube.addPosition(vertices);
    cube.addAttribute(unpackedColors, 'aColor', 4);
    cube.addIndices(cubeVertexIndices, false);

    gl.clearColor(0.0, 0.0, 0.0, 1.0);
    gl.enable(gl.DEPTH_TEST);

    POLY.utils.loop.add(draw);
}

init();
